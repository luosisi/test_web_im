<!--本Demo登陆测试帐号：test1，密码：123456, 测试对方账号：test2，密码：123456-->
<html>
<head>
    <title>Clock</title>
     <link rel="stylesheet" href="./dist/main.css">
     <link rel="stylesheet" href="./dist/webim.css">
    <script src="../demo/javascript/dist/webim.config.js"></script>
    <script src="./dist/strophe-1.2.8.min.js"></script>
    <script src="./dist/websdk-1.4.10.js"></script>
</head>
<body>
<div class="wrapper webim-chatwindow ">
    <div class="banner">
        <h1>HiChat</h1>
        <span id="status"></span>
    </div>
    <div id="historyMsg">
    </div>
    <div class="controls" >
        <div class="items">
            <input id="emoji" type="button" value="emoji" title="emoji" />
            <label for="sendImage" class="imageLable">
                <span class="icon_emoji"><input type="button" value="image" /></span>
                <span class="file"><input id="sendImage" type="file" value="image" /></span>
            </label>
        </div>
        <div class="textwrap">
            <textarea id="messageInput" placeHolder="请描述您的问题"></textarea>
            <input class="sendBtn" id="sendBtn" type="button"  value="发送">
        </div>
        <div id="emojiWrapper">
        </div>
    </div>
</div>


<script>
    /**
     * Created by clock on 16-11-25.
     */
    var conn = {};
    conn = new WebIM.connection({
        isMultiLoginSessions: WebIM.config.isMultiLoginSessions,
        https: typeof WebIM.config.https === 'boolean' ? WebIM.config.https : location.protocol === 'https:',
        url: WebIM.config.xmppURL,
        isAutoLogin: true,
        heartBeatWait: WebIM.config.heartBeatWait,
        autoReconnectNumMax: WebIM.config.autoReconnectNumMax,
        autoReconnectInterval: WebIM.config.autoReconnectInterval
    });

    // listern，添加回调函数
    conn.listen({
        onOpened: function (message) {          //连接成功回调，连接成功后才可以发送消息
            //如果isAutoLogin设置为false，那么必须手动设置上线，否则无法收消息
            // 手动上线指的是调用conn.setPresence(); 在本例中，conn初始化时已将isAutoLogin设置为true
            // 所以无需调用conn.setPresence();
            console.log("opened");
        },
        onTextMessage: function (message) {
            // 在此接收和处理消息，根据message.type区分消息来源，私聊或群组或聊天室
             var color;
            opt._displayNewMsg(message.from, message.data, color);
        },  //收到文本消息
        onEmojiMessage: function (message) {
            // 当为WebIM添加了Emoji属性后，若发送的消息含WebIM.Emoji里特定的字符串，connection就会自动将
            // 这些字符串和其它文字按顺序组合成一个数组，每一个数组元素的结构为{type: 'emoji(或者txt)', data:''}
            // 当type='emoji'时，data表示表情图像的路径，当type='txt'时，data表示文本消息
            console.log('Emoji');
        },   //收到表情消息
        onPictureMessage: function (message) {
            console.log('Picture');

            console.log(message)

            var options = {url: message.url};
            options.onFileDownloadComplete = function () {
                // 图片下载成功
                console.log('Image download complete!');
                opt._displayImage(message.from, message.url, "#000");
            };
            options.onFileDownloadError = function () {
                // 图片下载失败
                console.log('Image download failed!');
            };
            WebIM.utils.download.call(conn, options);       // 意义待查

        }, //收到图片消息
    });

    /**
     * Created by clock on 16-11-30.
     */
// open，登录
    var options = {
        apiUrl: WebIM.config.apiURL,
        user: "test1",
        pwd: "123456",
        appKey: WebIM.config.appkey
    };
    conn.open(options);


    // 私聊发送文本消息，发送表情同发送文本消息，只是会在对方客户端将表情文本进行解析成图片
    var sendPrivateText = function () {
        var id = conn.getUniqueId();
        var msg = new WebIM.message('txt', id);
        var messageInput = document.getElementById("messageInput");
        var txtMsg = messageInput.value;
        messageInput.value = '';
        messageInput.focus();
        msg.set({
            msg: txtMsg,                       // 消息内容
            to: 'test2',                          // 接收消息对象
            roomType: false,
            success: function (id, serverMsgId) {
            }
        });
        msg.body.chatType = 'singleChat';
        conn.send(msg.body);
        
        var color;
        opt._displayNewMsg('me', txtMsg, color);
    };

    // 私聊发送命令消息
    var sendPrivateCmd = function () {
        var id = conn.getUniqueId();
        var msg = new WebIM.message('cmd', id);
        msg.set({
            msg: 'ls',
            to: 'test2',
            roomType: false,
            success: function (id, serverMsgId) {
                console.log('CMD Success');
            }
        });
        msg.body.chatType = 'singleChat';
        conn.send(msg.body);
    };

    // 私聊发送图片消息
    var sendPrivateImg = function (e) {
        console.log(e)
        var id = conn.getUniqueId();
        var msg = new WebIM.message('img', id);
        var input = document.getElementById('sendImage');               // 选择图片的input
        var file = WebIM.utils.getFileUrl(input);                   // 将图片转化为二进制文件
        var allowType = {
            'jpg': true,
            'gif': true,
            'png': true,
            'bmp': true
        };
        if (file.filetype.toLowerCase() in allowType) {
            var option = {
                apiUrl: WebIM.config.apiURL,
                file: file,
                to: 'test2',
                roomType: false,
                chatType: 'singleChat',
                onFileUploadError: function () {
                    console.log('onFileUploadError');
                },
                onFileUploadComplete: function (data) {
                    console.log('onFileUploadComplete');
                },
                success: function () {
                    console.log('Success');
                },
                // flashUpload: WebIM.flashUpload               // 意义待查
            };
            msg.set(option);
            conn.send(msg.body);

             var color;

             if (e.target.files.length != 0) {
                 var file = e.target.files[0],

                     reader = new FileReader(),
                     color;
                 if (!reader) {
                     that._displayNewMsg('system', '!your browser doesn\'t support fileReader', 'red');
                     return;
                 };
                 reader.onload = function(event) {
                     opt._displayImage('me', event.target.result, color);
                 };
                 reader.readAsDataURL(file);
             };
        }
    };



    var opt = {
        _initialEmoji: function() {
            var emojiContainer = document.getElementById('emojiWrapper'),
                docFragment = document.createDocumentFragment();
            for (var i = 35; i > 0; i--) {
                var emojiItem = document.createElement('img');
                emojiItem.src = '../demo/images/faces/ee_' + i + '.png';
                emojiItem.title = i;
                docFragment.appendChild(emojiItem);
            };
            emojiContainer.appendChild(docFragment);
        },
        _displayNewMsg: function(user, msg, color) {
            var container = document.getElementById('historyMsg'),
                msgToDisplay = document.createElement('p'),
                date = new Date().toTimeString().substr(0, 8),
                //determine whether the msg contains emoji
                msg = opt._showEmoji(msg);

            msgToDisplay.style.color = color || '#000';
            msgToDisplay.innerHTML = user + '<span class="timespan">(' + date + '): </span>' + msg;
            container.appendChild(msgToDisplay);
            container.scrollTop = container.scrollHeight;
        },
        _displayImage: function(user, imgData, color) {
            var container = document.getElementById('historyMsg'),
                msgToDisplay = document.createElement('p'),
                date = new Date().toTimeString().substr(0, 8);
            msgToDisplay.style.color = color || '#000';
            msgToDisplay.innerHTML = user + '<span class="timespan">(' + date + '): </span> <br/>' + '<a href="' + imgData + '" target="_blank"><img src="' + imgData + '"/></a>';
            container.appendChild(msgToDisplay);
            container.scrollTop = container.scrollHeight;
        },
        _showEmoji: function(msg) {
            var match, result = msg,
                reg = /\[emoji:\d+\]/g,
                emojiIndex,
                totalEmojiNum = document.getElementById('emojiWrapper').children.length;
            while (match = reg.exec(msg)) {
                emojiIndex = match[0].slice(7, -1);
                if (emojiIndex > totalEmojiNum) {
                    result = result.replace(match[0], '[X]');
                } else {
                    result = result.replace(match[0], '<img class="emoji" src="../demo/images/faces/ee_' + emojiIndex + '.png" />');//todo:fix this in chrome it will cause a new request for the image
                };


            };
            return result;
        }
    }
</script>
<script>
    /**
     * Created by clock on 16-11-30.
     */
    window.onload = function () {
        document.getElementById('sendBtn').onclick = sendPrivateText;

        document.getElementById('sendImage').addEventListener('change', function(e) {
            sendPrivateImg(e);
        }, false);

        opt._initialEmoji();
        document.getElementById('emoji').addEventListener('click', function(e) {
            var emojiwrapper = document.getElementById('emojiWrapper');
            emojiwrapper.style.display = 'block';
            e.stopPropagation();
        }, false);
        document.body.addEventListener('click', function(e) {
            var emojiwrapper = document.getElementById('emojiWrapper');
            if (e.target != emojiwrapper) {
                emojiwrapper.style.display = 'none';
            };
        });
        document.getElementById('emojiWrapper').addEventListener('click', function(e) {
            var target = e.target;
            console.log(target)
            if (target.nodeName.toLowerCase() == 'img') {
                var messageInput = document.getElementById('messageInput');
                messageInput.focus();
                messageInput.value = messageInput.value + '[emoji:' + target.title + ']';
            };
        }, false);
    };
</script>
<script>
    // 贴图发送（放到消息模块里）
    document.addEventListener('paste', function (e) {
        if (e.clipboardData && e.clipboardData.types) {
            if (e.clipboardData.items.length > 0) {
                if (/^image\/\w+$/.test(e.clipboardData.items[0].type)) {
                    var blob = e.clipboardData.items[0].getAsFile();
                    var url = window.URL.createObjectURL(blob);
                    var id = conn.getUniqueId();//生成本地消息id

                    var msg = new WebIM.message('img', id);
                    msg.set({
                        apiUrl: WebIM.config.apiURL,
                        file: {data: blob, url: url},
                        to: 'test2',
                        roomType: false,
                        chatType: 'singleChat',
                        onFileUploadError: function (error) {
                            console.log("Error");
                        },
                        onFileUploadComplete: function (data) {
                            console.log("Complete");
                        },
                        success: function (id) {
                            console.log("Success");
                        }
                    });
                    conn.send(msg.body);
                }
            }
        }
    });
</script>
</body>
</html>